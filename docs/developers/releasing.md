# Releasing the operator

There are 4 components to release as part of the operator:

- The `mysql-agent` is located in the agent directory. It is started as a
  sidecar of the database StatefulSet and provide advanced features like backup
  and restore. It is released as a container image
- `Controllers` are logic that interact with Kubernetes from changes in the
  configuration. It is released as a container image
- The `Operator` reference the controller and includes the manifests including
  CRDs, permissions and the schedule of `Controllers`. It is also packaged and
  released as a container image and includes a script to update an index with
  all the releases

> Note: Releasing the operator requires access to the different components
> and the change to be correclty reviewed and tested. As a result only
> project owners can trigger a new release.

## Building the agent

The agent is built as part the CI. There is nothing to do to make it happen.

## Releasing the agent

Releasing the agent is actually part of the operator built process. As a matter
of fact, the agent is referenced in the `mysql-operator/main.go` file. To
proceed:

- Change the agent client part in the `mysql-operator/agent` directory
- Change the agent version in the `mysql-operator/main.go`.

There is a Makefile script that does the change for you. To run that script,

```shell
cd $(git rev-parse --show-toplevel)
cd mysql-operator/agent
make api
```

## Building Controllers

The controller is built as part the CI. Just pay attention to the fact that,
unless you have explicitly release the agent, it will be built with the last
release agent version.

## Releasing Controllers

Controllers are released with the operator.

## Building and Releasing the Operator

Building and releasing the operator is part of the same process that also
embeds the releasing of controllers. To proceed, you should prepare it and then
a build is actually automatically generated by a tag on the repository.

### Preparation

Preparing for a release of an operator implies the tasks below that are done
as part of pull requests on the repository:

- Update the `VERSION` and `PREV_VERSION` variables in the `.gally.yml` file of
  the `mysql-operator` subdirectory. There is a control that the tag matches
  this variable.
- Make sure you change the `spec.replaces` attribute in 
  `mysql-operator/config/manifests/bases/mysql-operator.clusterserviceversion.yaml`
  with the previous release. Once done, rebuild the bundle files.
- Update the `CHANGELOG.md` file with the list of enhancements and bugfix for
  the release
- Run all the tests that are part of the version. In particular, all the
  `mysql-operator/tests` integration and end-to-end tests that are built on
  `kuttl` and not yet part of the CI
- Make sure the agent latest version is used. The operator will not be released
  if it does not include the latest agent release. Make sure you run `make api`
  from `mysql-operator/agent`. This should regenerate the client API for the
  agent and add the tag for the AGENT in the API

Once all the steps above are performed, you are ready to ship the release.

### Releasing

The release actually consists in adding a tag named v${VERSION} on the main
branch and pushing it to Github. CircleCI does the rest ; it pushes :

## Documentation

The documentation website is part of a separate repository, even if all the
content is actually from `docs`. There is a separate process to install it.

## Build and release the Registry

see `make registry` in the `registry` directory. This commands update the
index.db file with the new operator. It creates a docker image to serve the
different versions. The publication of the registry is done outside of this
repository.

## Check the Operator gets updated

Once the new registry published, you can check your subscription and control
the Operator has been updated. The subscription should show the version is
the last one:

```shell
kubectl get sub -n mysql -o yaml
```

> Note: there is a bug [1347](https://github.com/operator-framework/operator-lifecycle-manager/issues/1347)
> with OLM previous than 0.15.0 that prevents `clusterServiceVersionNames` to
> be set correctly and prevent the upgrade of the operator. Make sure you use
> OLM 0.15.0+
